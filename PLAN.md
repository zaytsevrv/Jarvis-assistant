# JARVIS — Полный План Реализации (v3 FINAL)

## Контекст
- Соло-предприниматель из России, одна работа. Не программист (вайбкодинг)
- 4 устройства: 2 домашних ноутбука, рабочий (заблокирован), смартфон
- Каналы: Telegram, Gmail, Mail.ru, звонки (записи), Ozon, Avito, Wildberries, Yandex.Market, VseInstrumenty
- Рабочие файлы: Яндекс.Диск
- Подписка: Claude Max ($100/мес) — основной AI-движок
- Стратегия: Вариант A — чистый Python, модульная архитектура
- Цель: "второй мозг" — знает всё, напоминает, замечает паттерны, предлагает действия
- **Папка проекта**: `C:\Users\Honor\Desktop\My_Projects\Jarvis ассистент\`

---

## ЧАСТЬ 1: ОБЗОР ВСЕХ ФАЗ

| Фаза | Название | Что получаем | Когда |
|------|---------|-------------|-------|
| **0** | Инфраструктура | VPS, БД, мониторинг, Syncthing | Первая |
| **1** | Пассивная память | Telegram чтение + бот + AI-мозг + задачи | Сразу после 0 |
| **2** | Голос и почта | Whisper, email, календарь, покупки | После стабилизации Фазы 1 |
| **3** | Файлы и архивация | Яндекс.Диск, 3-уровневая память | После стабилизации Фазы 2 |
| **4** | Умный анализ | Паттерны, семантический поиск, pgvector | После 2+ месяцев данных |
| **5** | Расширенный мониторинг | Screenpipe, браузер, расширенная аналитика | После оценки необходимости |
| **6** | Автономность | Автоагенты, автоматические действия | Далёкое будущее |

**Правило**: каждая фаза стабилизируется минимум 2-4 недели перед переходом к следующей.

---

## ЧАСТЬ 2: ФАЗА 0 — ИНФРАСТРУКТУРА

### Что делаем
1. **VPS**
   - Hetzner CX22 (€4.5/мес, 2 vCPU, 4GB RAM, 40GB SSD) — если получится оплатить из РФ
   - Альтернатива: Timeweb Cloud (от 199 руб/мес) или Selectel
   - ОС: Ubuntu 22.04 LTS

2. **PostgreSQL 16** на том же VPS (бесплатно)
   - Таблицы создаются скриптом при первом запуске

3. **Python 3.11** + venv

4. **Claude Code CLI** установлен на VPS
   - Авторизация через подписку $100/мес
   - Тестируем: `claude -p "Привет, ответь одним словом"` — должно работать

5. **Anthropic SDK** (python) — для API-режима
   - `pip install anthropic`
   - API-ключ в `.env` (на будущее, когда/если переключишь на API)

6. **Syncthing** — синхронизация звонков смартфон→VPS
   - На смартфоне: Send Only, папка с записями звонков
   - На VPS: Receive Only, директория `/data/calls/incoming/`
   - Настройка: только Wi-Fi или все сети (на твой выбор)

7. **systemd** — сервисы для каждого модуля
   - `Restart=always`, `RestartSec=10`
   - Автозапуск при перезагрузке VPS

8. **UptimeRobot** (бесплатно) — внешний пинг VPS каждые 5 минут

9. **Первоначальный деплой** — один bash-скрипт
   - Claude генерирует скрипт → ты запускаешь → всё устанавливается
   - После этого SSH больше не нужен (управление через Telegram бот)

### Стоимость Фазы 0
| Компонент | Стоимость |
|-----------|-----------|
| VPS | $5-7/мес |
| PostgreSQL | $0 |
| Syncthing | $0 |
| UptimeRobot | $0 |
| **Итого** | **$5-7/мес** |

---

## ЧАСТЬ 3: ФАЗА 1 — ПАССИВНАЯ ПАМЯТЬ

### Модуль 1.1: telegram_listener.py
**Что делает**: подключается к Telegram через Telethon, читает все сообщения

**Как работает Telethon:**
- Подключается как второй клиент твоего аккаунта (MTProto, родной протокол Telegram)
- Видит ВСЁ: личные чаты, группы, каналы, голосовые, файлы
- Виден как устройство в Настройки → Устройства
- Event-driven: Telethon сам получает события, не polling

**Логика обработки:**
- **Whitelist (10-15 чатов)** — анализируются AI, ищутся задачи/обещания
- **Все остальные чаты** — молча сохраняются в БД (для будущего поиска), AI не прогоняет
- **Игнор**: стикеры, GIF, пересланные посты из каналов, сервисные сообщения

**Детекция новых контактов:**
- Если пишет НОВЫЙ контакт (не в whitelist) → уведомление в бот:
  ```
  Новый контакт: Иванов (+7-xxx). Первое сообщение: "Добрый день..."
  [Мониторить] [Только сохранять] [Игнорировать]
  ```

**Безопасность Telethon:**
| Риск | Вероятность | Защита |
|------|------------|--------|
| Бан за UserBot | Низкая (только чтение) | Rate limiting, никаких действий кроме чтения |
| Flood wait | Средняя | FloodWaitError → пауза + повтор |
| Переавторизация | Низкая | Session-файл, уведомление при проблеме |
| Утечка session | Низкая | Шифрование, firewall, fail2ban |

**Правила:**
1. НИКАКИХ автоматических действий через Telethon — только чтение
2. Event-driven, не polling
3. Одна сессия
4. Session-файл зашифрован и бэкапится
5. Fallback: если аккаунт заблокируют — бот работает, можно пересылать ему сообщения вручную

**Реалистичная отправка сообщений (когда ты разрешишь):**
Если ты согласуешь текст и нажмёшь "Отправить":
1. Пауза 2-5 секунд (случайная)
2. `SetTypingRequest` → статус "печатает..." в чате получателя
3. Длительность "печатания" пропорциональна длине (~1 сек на 10-15 символов)
4. Если >200 символов — разбивка на 2-3 сообщения с паузами 1-3 сек
5. Никаких эмодзи, маркдауна, форматирования (если ты сам так не пишешь)
6. Стиль текста — деловой, лаконичный (настраивается)

### Модуль 1.2: telegram_bot.py
**Что делает**: Telegram бот (@JarvisAssistantBot), интерфейс для пользователя

**Команды и кнопки:**
| Команда/кнопка | Что делает |
|---------------|-----------|
| Кнопка **"Запрос"** | Свободный вопрос к AI по всей памяти |
| `/tasks` | Список активных задач с дедлайнами |
| `/summary` | Краткое содержание дня |
| `/health` | Статус всех модулей + VPS + БД |
| `/admin` | Управление: перезапуск, логи, бэкап |
| `/mode` | Текущий AI-режим + переключение CLI/API |
| `/settings` | Настройки (лимиты, расписание, whitelist) |
| `/help` | Компактная справка по всем командам |

**Команда /help — справка:**
Одно компактное сообщение (один экран), без захламления чата:
```
КОМАНДЫ JARVIS:

Запрос     — свободный вопрос (кнопка внизу)
/tasks     — активные задачи с дедлайнами
/summary   — краткое содержание дня
/health    — статус системы и модулей
/admin     — управление: перезапуск, логи, бэкап
/mode      — AI-режим (CLI/API), переключение
/settings  — настройки (лимиты, whitelist, расписание)
/help      — эта справка

ТЕКСТОМ (без команд):
"Переключи на API" — смена AI-режима
Любой вопрос — Jarvis поймёт контекст
```
Не всплывает сама, не захламляет. Вызывается только по `/help`.

**Индикатор AI-режима (в реальном времени):**
В КАЖДОМ ответе бота — маленькая метка внизу:
```
[ответ на запрос]

— CLI mode | 9 модулей OK
```
или:
```
[ответ на запрос]

— API mode ($0.02) | 9 модулей OK
```

Таким образом ты ВСЕГДА видишь:
- Какой режим AI активен (CLI или API)
- Если API — сколько стоил этот конкретный запрос
- Статус системы (сколько модулей работает)

**Переключение режима:**
Вариант 1 — команда:
```
/mode

Текущий режим: CLI (Claude Code, подписка)
[Переключить на API]
```

Вариант 2 — текстом:
```
Ты: "Переключи на API"
Jarvis: "Переключено на Claude API. Теперь расходуются токены.
Ориентировочно $15-25/мес при текущей нагрузке.
Для возврата: /mode или напиши 'переключи на CLI'"

— API mode | 9 модулей OK
```

### Модуль 1.3: ai_brain.py
**Что делает**: единый AI-мозг, обёртка с dual-mode

**Архитектура dual-mode:**
```python
# Упрощённая логика:
class AIBrain:
    def __init__(self):
        self.mode = db.get_setting("ai_mode")  # "cli" или "api"

    def ask(self, prompt, model="sonnet"):
        if self.mode == "cli":
            return self._ask_cli(prompt, model)
        else:
            return self._ask_api(prompt, model)

    def _ask_cli(self, prompt, model):
        # subprocess: claude -p "..." --model model
        result = subprocess.run(["claude", "-p", prompt], ...)
        return result.stdout

    def _ask_api(self, prompt, model):
        # anthropic SDK
        response = client.messages.create(model=model, ...)
        return response.content[0].text
```

- Переменная `ai_mode` хранится в таблице `settings` в PostgreSQL
- При переключении через бот — одна строка в БД меняется
- Все модули используют `ai_brain.ask()` — им не важно, CLI или API под капотом

**Классификация сообщений:**
AI получает текст → определяет:
- Тип: `task` / `promise_mine` / `promise_incoming` / `info` / `question` / `spam`
- Суть: краткое описание
- Дедлайн: если указан
- Ответственный: кто должен выполнить
- Confidence: 0-100%

### Модуль 1.4: confidence_manager.py
**Что делает**: управляет неуверенными классификациями

**Три зоны:**
| Уверенность | Действие |
|-------------|----------|
| **>80%** | Молча создаёт задачу |
| **50-80%** | В "корзину неуверенных" (батч-разбор) |
| **<50%** | Молча сохраняет как info |

**Батч-разбор:**
- Ежедневно в **16:00 МСК** — одно сообщение со всеми накопленными вопросами:
```
За сегодня я засомневался в 4 сообщениях:

1. [ ] Козлов (11:30): "ну можно и оплатить на неделе" — обещание?
2. [ ] Смирнов (13:15): "надо бы как-нибудь встретиться" — задача?
3. [ ] Петров (14:42): "я попробую до четверга" — обещание?
4. [ ] Email от Логистик-Транс: "просим рассмотреть" — задача?

[Все задачи] [Ничего] [Выбрать]
```

**Исключение — срочное:**
Если AI определяет, что информация потенциально СРОЧНАЯ/ВАЖНАЯ (дедлайн сегодня-завтра, финансы, юридическое) — спрашивает СРАЗУ, не ждёт 16:00:
```
СРОЧНОЕ: Козлов (14:32): "оплата должна уйти сегодня, иначе штраф"
Уверенность: 72%. Это задача с дедлайном СЕГОДНЯ?
[Да, срочная задача] [Нет] [Разберусь позже]
```

**Лимит:** 10 вопросов/день (настраивается через `/settings`). Если больше — остальные молча в info.

**Самообучение:**
Таблица `classification_feedback`:
- Каждый твой ответ (Да/Нет) записывается с контекстом: чат, ключевые слова, тип
- Через месяц AI формирует правила: "разговоры с Козловым об оплате = всегда обещание (confidence +20%)"
- Количество вопросов снижается в 3-5 раз за первый месяц

### Модуль 1.5: scheduler.py
**Что делает**: APScheduler, запуск периодических задач

| Время (МСК) | Задача |
|-------------|--------|
| 08:00 | Утренний брифинг: календарь + почта + задачи + здоровье |
| 16:00 | Батч confidence-вопросов |
| 20:00 | Вечерний дайджест: итоги дня |
| Каждый час | Проверка дедлайнов, напоминания |
| Воскресенье 10:00 | Еженедельный анализ: паттерны, тренды |
| 1-е число, 03:00 | Архивация HOT→WARM (Фаза 3) |

### Модуль 1.6: watchdog.py
**Что делает**: мониторинг здоровья всех модулей + авто-ремонт

**3 уровня мониторинга:**

**Уровень 1: systemd (автоматический)**
```ini
[Service]
Restart=always
RestartSec=10
StartLimitIntervalSec=300
StartLimitBurst=5
```
Если процесс упал → systemd перезапустит через 10 сек. Макс 5 перезапусков за 5 минут (защита от бесконечного цикла).

**Уровень 2: watchdog.py (внутренний)**
- Каждый модуль каждые 5 мин пишет heartbeat в таблицу `health_checks`
- watchdog проверяет: все отметились?
- Если модуль не ответил 3 раза (15 мин):
  1. Уведомление в бот
  2. `systemctl restart jarvis-MODULE`
  3. Ждёт 30 сек → проверяет heartbeat
  4. Если ожил → "Модуль X перезапущен, работает"
  5. Если нет → эскалация (см. ниже)

**Уровень 3: UptimeRobot (внешний)**
- Пингует VPS каждые 5 мин
- Если VPS не отвечает → email + push-уведомление

**Эскалация — когда Jarvis не может починить сам:**
```
ПРОБЛЕМА: Модуль telegram_listener не работает.
Автоперезапуск не помог (3 попытки за 5 минут).
Ошибка: "Session expired, please re-login"

Это значит: Telegram попросил переавторизоваться.
Без этого чтение чатов не работает.
Остальные модули (8/9) в норме.

ЧТО ДЕЛАТЬ:
1. Открой Claude Code (терминал)
2. Введи: ssh jarvis@[IP-адрес-сервера]
3. Введи: cd /opt/jarvis && python3 reauth_telegram.py
4. Telegram пришлёт код в приложение — введи его
5. Готово. Listener перезапустится автоматически.

Или: скопируй текст ошибки выше и отправь в Claude Code —
он поможет разобраться.
```

Библиотека типичных ошибок с пошаговыми инструкциями заложена в код:
| Ошибка | Инструкция |
|--------|-----------|
| Telethon session expired | Переавторизация через скрипт |
| IMAP auth failed | Проверить пароль приложения |
| PostgreSQL connection refused | Перезапуск PostgreSQL |
| Whisper API 429 (rate limit) | Подождать, автоповтор через 60 сек |
| Disk space >90% | Запустить архивацию через /admin |
| Claude CLI timeout | Проверить подписку, переключить на API |

**Утренний/вечерний статус:**
В каждом дайджесте:
```
СИСТЕМА: 9/9 модулей OK | CLI mode | БД: 142 MB | VPS: CPU 12%, RAM 58%
```

**Команда /health:**
```
Статус (16:35 МСК):

telegram_listener   OK   uptime: 3д 14ч  heartbeat: 2м назад
telegram_bot        OK   uptime: 5д 02ч  heartbeat: 1м назад
ai_brain            OK   uptime: 5д 02ч  mode: CLI
email_checker       OK   uptime: 0д 02ч  перезапуск: 12:30 (IMAP timeout)
calendar_sync       OK   uptime: 5д 02ч  heartbeat: 4м назад
whisper_processor   OK   uptime: 5д 02ч  очередь: 0 файлов
yadisk_monitor      OK   uptime: 5д 02ч  heartbeat: 2м назад
watchdog            OK   uptime: 5д 02ч
scheduler           OK   uptime: 5д 02ч  след. задача: 16:00 (батч)

БД: PostgreSQL OK, 142 MB / 40 GB (0.4%)
VPS: CPU 12% | RAM 2.3/4 GB (58%) | Disk 14/40 GB (34%)
Syncthing: подключён, послед. синхр: 13:45
AI mode: CLI (подписка)
```

### Модуль 1.7: admin_handler.py (часть telegram_bot.py)
**Что делает**: управление VPS через Telegram бот

```
/admin

[Перезапустить модуль] [Показать логи] [Бэкап БД]
[Очистить старые данные] [Статус VPS] [Настройки]
```

- **Перезапуск модуля** → выбор из списка → `systemctl restart`
- **Логи** → последние 20 строк journalctl для выбранного модуля
- **Бэкап** → `pg_dump` → показывает размер и путь
- **Статус VPS** → CPU, RAM, disk, uptime

### Модуль 1.8: db.py
**Что делает**: работа с PostgreSQL

**Таблицы Фазы 1:**
```
messages          — все сообщения Telegram (sender, chat, text, timestamp, media_type, processed)
tasks             — задачи и обещания (type, description, who, deadline, status, confidence, source)
settings          — настройки (ai_mode, confidence_limit, batch_time, whitelist и т.д.)
health_checks     — heartbeat модулей (module, status, timestamp, error)
classification_feedback — самообучение (message_id, predicted, actual, context)
contacts          — контакты (telegram_id, name, phone, chat_type, monitored, first_seen)
```

### Стоимость Фазы 1
| Компонент | Стоимость/мес |
|-----------|---------------|
| VPS | $5-7 |
| Claude (через подписку) | $0 |
| Всё остальное | $0 |
| **Итого** | **$5-7/мес** |

---

## ЧАСТЬ 4: ФАЗА 2 — ГОЛОС И ПОЧТА

### Модуль 2.1: whisper_processor.py
**Что делает**: расшифровка голосовых (Telegram) и записей звонков

**Источники аудио:**
1. Голосовые из Telegram → Telethon скачивает → очередь
2. Записи звонков → Syncthing доставляет в `/data/calls/incoming/` → inotify замечает

**Pipeline:**
```
Аудиофайл → Whisper API → текст (русский, ~95% точность) → PostgreSQL → ai_brain (анализ) → уведомление
```

**Для звонков — дополнительно:**
- Попытка определить контакт по номеру телефона (из таблицы contacts)
- Если номер неизвестен — "Звонок: +7-xxx-xxx-xx-xx (неизвестный контакт)"

### Модуль 2.2: email_checker.py
**Что делает**: проверяет Gmail + Mail.ru по IMAP каждые 5 минут

**Настройка:**
- Gmail: IMAP + App Password (Google аккаунт → Безопасность → Пароли приложений)
- Mail.ru: IMAP + пароль приложения (Настройки → Безопасность → Пароли для приложений)

**Классификация писем:**
| Тип | Действие |
|-----|----------|
| Важное (от контактов, по задачам) | Уведомление в бот |
| Чек/квитанция (Ozon, WB...) | → purchase_tracker |
| Рутина (рассылки, новости) | Молча в БД |
| Спам | Игнор |

### Модуль 2.3: calendar_sync.py
**Что делает**: синхронизация Google Calendar через официальный API

- Раз в час проверяет события
- Данные для утреннего брифинга: "Сегодня: 3 встречи, 2 дедлайна"
- Если событие через 30 мин и ты ещё не "подтвердил" → напоминание

### Модуль 2.4: purchase_tracker.py
**Что делает**: парсинг email-чеков, трекинг покупок

**Детекция чеков по отправителю:**
- `noreply@ozon.ru` → Ozon
- `info@wildberries.ru` → Wildberries
- `no-reply@market.yandex.ru` → Yandex.Market
- `noreply@avito.ru` → Avito
- `*@vseinstrumenti.ru` → VseInstrumenty

**Парсинг:**
AI (Claude) анализирует текст письма и извлекает:
- Название товара, цена, дата, номер заказа, статус

**Таблица `purchases`:**
```
id, store, item_name, price, currency, order_number, purchase_date, delivery_date, status, email_id, raw_text
```

**Запросы:**
- "где покупал шуруповёрт" → полнотекстовый поиск по item_name
- "сколько потратил на Ozon за январь" → SUM + date range
- "последние покупки" → ORDER BY purchase_date DESC

### Стоимость Фазы 2
| Компонент | Стоимость/мес |
|-----------|---------------|
| Whisper API (~150 мин/мес) | $0.90-3 |
| IMAP (Gmail, Mail.ru) | $0 |
| Google Calendar API | $0 |
| **Итого доп.** | **+$1-3/мес** |

**Общая стоимость (Фазы 0-2):** $6-10/мес

---

## ЧАСТЬ 5: ФАЗА 3 — ФАЙЛЫ И АРХИВАЦИЯ

### Модуль 3.1: yadisk_monitor.py
**Что делает**: мониторинг Яндекс.Диска через облачный REST API

**Важно**: работает НАПРЯМУЮ С ОБЛАКОМ. Не зависит от того, включён ли домашний ПК. Как только файл попадает в облако Яндекс.Диска (с любого устройства) — Jarvis увидит его.

**Endpoint:** `GET https://cloud-api.yandex.net/v1/disk/resources/last-uploaded`

**Каждые 10 минут:**
1. Запрос последних загруженных файлов
2. Сравнение с тем, что уже в БД
3. Новые файлы → индексация:
   - `.xlsx` → openpyxl (извлечение структуры, заголовков)
   - `.docx` → python-docx (извлечение текста)
   - `.pdf` → pdfplumber (извлечение текста)
   - Остальные → только метаданные (имя, размер, дата)
4. Уведомление: "Новый файл: Смета_Петров.xlsx, связано с..."

**Таблица `files`:**
```
id, path, name, size, modified, created, file_type, extracted_text, related_tasks, yandex_resource_id
```

### Модуль 3.2: memory_archiver.py
**Что делает**: 3-уровневая архитектура памяти, управление жизненным циклом данных

**3 уровня:**
| Уровень | Возраст | Что хранится | Где |
|---------|---------|-------------|-----|
| **HOT** | 0-30 дней | Полные тексты | Основные таблицы PostgreSQL |
| **WARM** | 1-12 мес | Суммари + ключевые факты | Таблицы `*_archive` |
| **COLD** | >1 года | Только факты. Полные тексты в gzip | Сжатые дампы на VPS |

**Ежемесячная архивация (автоматическая, 1-е число, 03:00):**
1. Данные старше 30 дней → AI генерирует суммари за каждый день
2. Суммари → `*_archive` таблицы
3. Полные тексты → gzip → `/data/cold/`
4. Из основных таблиц — удаление (освобождение места)

**Ежегодная архивация:**
1. WARM данные старше 12 мес → извлечение ФАКТОВ
   - "Козлов: постоянный контрагент. Средний срок оплаты: 12 дней"
2. Факты → таблица `facts` (навсегда, минимальный объём)
3. Суммари → cold (gzip)

**Жизненный цикл задач:**
| Статус | Что происходит |
|--------|---------------|
| Активная | HOT, видна в /tasks, напоминания |
| Выполнена | HOT 30 дней → WARM (суммари) |
| Просрочена >30д | Jarvis спрашивает: "Закрыть? [Да] [Нет, напомни]" |
| Отменена | Через 30 дней → WARM |

Выполненные задачи НИКОГДА не удаляются полностью → суммари навсегда.

**Реалистичные размеры:**
| Данные | Объём/год |
|--------|-----------|
| Telegram (100 сообщ/день) | ~18 MB |
| Emails (20/день) | ~36 MB |
| Звонки (2/день) | ~7 MB |
| Голосовые (5/день) | ~3.5 MB |
| Файлы (метаданные) | ~1.8 MB |
| Покупки | ~0.7 MB |
| Задачи, суммари | ~3.5 MB |
| **Итого** | **~70 MB/год** |

При 40 GB VPS — данных хватит на десятки лет. Но архивация нужна для скорости поиска.

**Мониторинг размера (в воскресном дайджесте):**
```
ПАМЯТЬ:
- БД: 142 MB / 40 GB (0.4%)
- HOT (30д): 6 MB | WARM (1-12м): 58 MB | COLD: 78 MB
- Записей: 32,547 сообщ | 2,340 писем | 184 звонка | 47 покупок
Рекомендаций по очистке нет.
```

### Стоимость Фазы 3
| Компонент | Стоимость/мес |
|-----------|---------------|
| Yandex.Disk API | $0 |
| Доп. disk space | $0 (влезает в 40GB) |
| **Итого доп.** | **$0** |

**Общая стоимость (Фазы 0-3):** $6-10/мес

---

## ЧАСТЬ 6: ФАЗА 4 — УМНЫЙ АНАЛИЗ (после 2+ месяцев данных)

**Когда переходить**: после 2 месяцев стабильной работы Фаз 1-3. Только если ощущается нехватка текущего функционала.

### 4.1: Семантический поиск (pgvector)
**Зачем**: полнотекстовый поиск не находит "похожие" вещи. Ты спрашиваешь "всё про транспортные расходы" — а в сообщениях написано "пробег", "бензин", "маршрут". Семантический поиск понимает смысл.

**Что делаем:**
- Расширение pgvector для PostgreSQL (бесплатно, на том же VPS)
- Embedding-модель: BGE-M3 (лучшая для русского, open-source) или через API
- Каждое сообщение/письмо → embedding (вектор 1024 размерности) → столбец в таблице
- Запрос → embedding → cosine similarity → топ-10 похожих записей

**Стоимость:** $0 (pgvector бесплатный, embedding можно делать через Claude или локально)
**Сложность:** средняя. Нужно добавить embedding pipeline и изменить поисковые запросы.

### 4.2: Паттерн-анализатор (Workflow Miner)
**Зачем**: Jarvis замечает закономерности, которые ты сам не видишь.

**Что делаем:**
- Раз в неделю Claude анализирует сводку за 7 дней
- Ищет: повторяющиеся задержки, регулярные забытые задачи, всплески активности
- Примеры:
  - "Ты 4 раза за месяц забывал отправить акты. Всегда в понедельник-вторник."
  - "Козлов задерживает оплату в среднем на 5 дней. Рекомендую ставить дедлайн на 5 дней раньше."
  - "Ты больше всего задач получаешь в голосовых (67%). Рассмотри текстовые инструкции."

**Стоимость:** $0 (один запрос в неделю через подписку)
**Сложность:** низкая. По сути — хороший промпт + сводка данных за неделю.

### 4.3: Контактный граф
**Зачем**: понимать связи между людьми и компаниями.

**Что делаем:**
- PostgreSQL таблица связей: "Козлов ↔ Логистик-Транс ↔ пробег ↔ оплата"
- Не Neo4j (избыточно). Простые таблицы `entity_links`
- Когда спрашиваешь "всё про Логистик-Транс" — Jarvis находит не только прямые упоминания, но и связанных людей и темы

**Стоимость:** $0
**Сложность:** средняя

### 4.4: Система целей (Goal Tracker)
**Зачем**: не только задачи, но и долгосрочные цели.

**Что делаем** (идея из Agent Second Brain):
- Структура: 3-летнее видение → годовые цели → месячные → недельные
- Jarvis сопоставляет текущие задачи с целями: "Эта задача двигает цель X"
- Еженедельный отчёт: "На этой неделе 60% задач были связаны с целью Y, 0% с целью Z"

**Стоимость:** $0
**Сложность:** низкая (таблица goals + промпт для анализа)

### Стоимость Фазы 4
| Компонент | Стоимость/мес |
|-----------|---------------|
| pgvector | $0 |
| Embedding (если через API) | $1-3 |
| Всё остальное | $0 |
| **Итого доп.** | **$0-3/мес** |

**Общая стоимость (Фазы 0-4):** $6-13/мес

---

## ЧАСТЬ 7: ФАЗА 5 — РАСШИРЕННЫЙ МОНИТОРИНГ (оценить через 3-4 месяца)

**Когда переходить**: только если реально не хватает. Каждый пункт оценивается отдельно.

### 5.1: Screenpipe — мониторинг экрана
**Зачем**: Jarvis видит, что ты делаешь на компьютере. "Что я делал вчера с 14 до 16?" — и он покажет.

**Что это**: open-source (github.com/mediar-ai/screenpipe, 12k+ звёзд). Работает на Windows/Mac. Делает скриншоты, OCR, сохраняет текст.

**Что делаем:**
- Установить Screenpipe на домашний ноутбук
- Screenpipe сохраняет данные локально
- Периодически выгружать индекс на VPS (через API Screenpipe)

**Стоимость:** $0 (open-source)
**Сложность:** средняя. Screenpipe уже написан, нужна только интеграция.
**Решение о внедрении:** после 3 месяцев, если чувствуешь что "теряешь" контекст рабочего дня.

### 5.2: Мониторинг браузера (история + закладки)
**Зачем**: "Какой сайт я вчера смотрел про запчасти?" — Jarvis найдёт.

**Что делаем:**
- Расширение для Chrome/Firefox, которое отправляет URL + заголовок страницы на VPS
- Или: периодический экспорт истории браузера
- Индексация в PostgreSQL

**Стоимость:** $0
**Сложность:** средняя. Нужно расширение для браузера.
**Решение о внедрении:** только если реально нужно искать по истории браузера.

### 5.3: Расширенная аналитика расходов
**Зачем**: не просто "где покупал шуруповёрт", а полная картина расходов.

**Что делаем:**
- Парсинг всех чеков (не только крупные магазины)
- Категоризация: транспорт, еда, инструменты, одежда...
- Месячный отчёт: "В январе потратил X руб. +15% к декабрю. Основной рост: категория Y"

**Стоимость:** $0
**Сложность:** низкая (расширение purchase_tracker)
**Решение о внедрении:** если хочется контролировать расходы.

### 5.4: Интеграция с банковскими SMS/push
**Зачем**: реалтайм-уведомления о транзакциях, автоматическая проверка оплат.

**Что делаем:**
- SMS о транзакциях → пересылаются Jarvis через Telegram
- Или: Tasker на Android перехватывает push от банка → отправляет боту
- Jarvis сопоставляет: "Козлов обещал оплату → пришёл перевод 50,000 руб → обещание выполнено"

**Стоимость:** $0
**Сложность:** средняя (Tasker настройка)
**Решение о внедрении:** если хочется автоматической проверки оплат.

### Стоимость Фазы 5
Все компоненты: **$0/мес** (open-source, нет дополнительных API)

---

## ЧАСТЬ 8: ФАЗА 6 — АВТОНОМНОСТЬ (далёкое будущее, 6+ месяцев)

**Когда переходить**: только после полугода стабильной работы и глубокого понимания, что реально нужно. Каждый пункт — отдельное решение.

### 6.1: Автоматические ответы (без подтверждения)
**Зачем**: для рутинных, шаблонных ответов не нужно каждый раз подтверждать.

**Что делаем:**
- Список "доверенных шаблонов": "Добрый день, получили, спасибо" / "Да, в работе" / "Ок, принято"
- Если AI определяет, что подходит шаблон (confidence >95%) + чат в "доверенном" списке → отправляет сам
- Лог всех автоотправленных сообщений в вечернем дайджесте

**Риски:** высокие. Начинать только с самых безобидных шаблонов.
**Решение о внедрении:** через 6+ месяцев, когда доверие к системе высокое.

### 6.2: Проактивные подсказки (Shadow Mode lite)
**Зачем**: Jarvis предлагает действия ДО того, как ты попросил.

**Примеры:**
- "Завтра встреча с Петровым. Последний раз вы обсуждали акт сверки — хочешь подготовить?"
- "Козлов не отвечает 5 дней. Обычно он отвечает за 2 дня. Напомнить ему?"
- "На Яндекс.Диске появился файл от бухгалтера — возможно, связан с запросом от налоговой"

**Стоимость:** $0 (через подписку)
**Сложность:** средняя. Нужен хороший промпт + контекст.

### 6.3: MCP-интеграции
**Зачем**: Claude напрямую работает с внешними сервисами через Model Context Protocol.

**Возможные MCP-серверы:**
- Todoist → управление задачами
- Google Docs → создание/редактирование документов
- Notion → ведение заметок

**Стоимость:** $0 (MCP open-source)
**Сложность:** средняя

### 6.4: Computer Use (автоматизация действий на ПК)
**Зачем**: Jarvis сам заполняет формы, создаёт документы, отправляет отчёты.

**Статус (2026):** технология работает в демо, но не для 24/7 продакшена. Нестабильна.
**Решение:** ждать, когда технология созреет. Пересмотреть через год.

### 6.5: Self-Healing Code
**Зачем**: Jarvis сам чинит свой код при ошибках.

**Статус (2026):** работает для простых баггов. Для сложных (API изменился, библиотека обновилась) — ненадёжно. Рекурсивные попытки могут тратить ресурсы.
**Решение:** не реализовывать. Лучше хороший мониторинг + пошаговые инструкции (Фаза 1).

---

## ЧАСТЬ 9: СВОДНАЯ СТОИМОСТЬ

### Постоянные расходы

| Фаза | Компоненты | Доп. стоимость/мес |
|------|-----------|-------------------|
| 0-1 | VPS + Claude (подписка) | $5-7 |
| 2 | + Whisper API | +$1-3 |
| 3 | + Яндекс.Диск (бесплатно) | +$0 |
| 4 | + pgvector/embedding | +$0-3 |
| 5 | + Screenpipe (бесплатно) | +$0 |
| 6 | + MCP (бесплатно) | +$0 |

**Итого Фазы 0-3: $6-10/мес** (поверх подписки Claude $100)
**Итого максимум (все фазы): $6-13/мес**

### Если переключить на API-режим
| Компонент | Стоимость/мес |
|-----------|---------------|
| VPS | $5-7 |
| Claude Haiku (классификация) | $5-9 |
| Claude Sonnet (ответы, анализ) | $9-15 |
| Whisper API | $1-3 |
| **Итого** | **$20-34/мес** |

---

## ЧАСТЬ 10: АРХИТЕКТУРА — ПОЛНАЯ СХЕМА

```
УСТРОЙСТВА:
  Смартфон
  ├── Syncthing → записи звонков → VPS
  ├── Telegram (обычное использование)
  └── [Фаза 5.4] Tasker → банковские push → VPS

  Рабочий ПК (заблокирован)
  └── Яндекс.Диск клиент → облако

  Домашний ноутбук
  └── [Фаза 5.1] Screenpipe → VPS

VPS:
  ┌─ telegram_listener.py ─┐
  │  Telethon: чтение чатов │
  │  Скачивание голосовых   │
  │  Детекция новых контакт │
  │  Реалистичная отправка  │
  └────────────────────────┘

  ┌─ telegram_bot.py ──────┐
  │  aiogram 3: интерфейс  │
  │  "Запрос", /tasks, etc │
  │  /health, /admin, /mode│
  │  Индикатор AI-режима   │
  │  Inline-подтверждения  │
  └────────────────────────┘

  ┌─ ai_brain.py ──────────┐
  │  Dual-mode: CLI / API  │
  │  Классификация + conf. │
  │  Ответы, анализ        │
  │  Суммари для архивации │
  └────────────────────────┘

  ┌─ confidence_manager.py ┐
  │  Батч 16:00 МСК        │
  │  Срочное → сразу       │
  │  Лимит 10/день         │
  │  Самообучение          │
  └────────────────────────┘

  ┌─ email_checker.py ─────┐
  │  IMAP: Gmail + Mail.ru │
  │  Классификация писем   │
  │  Чеки → purchase_track │
  └────────────────────────┘

  ┌─ purchase_tracker.py ──┐
  │  Парсинг email-чеков   │
  │  Ozon, WB, Avito, YM   │
  │  VseInstrumenty        │
  └────────────────────────┘

  ┌─ calendar_sync.py ─────┐
  │  Google Calendar API   │
  └────────────────────────┘

  ┌─ whisper_processor.py ─┐
  │  Whisper API           │
  │  Голосовые + звонки    │
  │  inotify на incoming/  │
  └────────────────────────┘

  ┌─ yadisk_monitor.py ────┐
  │  Yandex.Disk REST API  │
  │  Облачный (не локальн) │
  │  xlsx/docx extraction  │
  └────────────────────────┘

  ┌─ memory_archiver.py ───┐
  │  HOT → WARM → COLD     │
  │  Ежемесячная архивация │
  │  Мониторинг размера    │
  └────────────────────────┘

  ┌─ scheduler.py ─────────┐
  │  08:00 брифинг         │
  │  16:00 батч confidence │
  │  20:00 дайджест        │
  │  Каждый час: дедлайны  │
  │  Вс: еженедельный     │
  │  1-е число: архивация  │
  └────────────────────────┘

  ┌─ watchdog.py ──────────┐
  │  Heartbeat 5 мин       │
  │  Авто-перезапуск       │
  │  Эскалация с инструкц. │
  │  Пошаговые рекомендации│
  └────────────────────────┘

  ┌─ PostgreSQL ───────────┐
  │  messages / _archive   │
  │  tasks                 │
  │  emails / _archive     │
  │  files                 │
  │  calls                 │
  │  purchases             │
  │  daily_summaries       │
  │  health_checks         │
  │  settings              │
  │  contacts              │
  │  classification_feedbk │
  │  facts (навсегда)      │
  │  [Ф4] embeddings       │
  │  [Ф4] entity_links     │
  │  [Ф4] goals            │
  └────────────────────────┘

  ┌─ Syncthing ────────────┐
  │  Приём звонков с тел.  │
  └────────────────────────┘

  ┌─ UptimeRobot ──────────┐
  │  Внешний пинг VPS      │
  └────────────────────────┘
```

---

## ЧАСТЬ 11: ФУНКЦИИ (сводная таблица)

| # | Функция | Описание | Фаза | Стоимость |
|---|---------|---------|------|-----------|
| 1 | Память переписок | Все сообщения Telegram в БД | 1 | $0 |
| 2 | Ловец задач | AI находит задачи/обещания с confidence | 1 | $0 |
| 3 | Свободный вопрос | Кнопка "Запрос" — поиск по всей памяти | 1 | $0 |
| 4 | Список задач | /tasks с дедлайнами и статусами | 1 | $0 |
| 5 | Утренний брифинг | 08:00: календарь + почта + задачи + здоровье | 1 | $0 |
| 6 | Вечерний дайджест | 20:00: итоги дня, паттерны | 1 | $0 |
| 7 | Мониторинг здоровья | /health, автоуведомления, автоперезапуск | 1 | $0 |
| 8 | Управление через TG | /admin: перезапуск, логи, бэкап | 1 | $0 |
| 9 | Dual-mode AI | CLI/API с индикатором и переключением | 1 | $0 |
| 10 | Батч-подтверждение | 16:00: разбор неуверенных классификаций | 1 | $0 |
| 11 | Новые контакты | Уведомление о незнакомых контактах | 1 | $0 |
| 12 | Самообучение | Обратная связь → улучшение классификации | 1 | $0 |
| 13 | Реалист. отправка | "Печатает...", задержки, разбивка | 1 | $0 |
| 14 | Расшифровка голосовых | Whisper API для голосовых Telegram | 2 | $0.006/мин |
| 15 | Расшифровка звонков | Syncthing + Whisper | 2 | $0.006/мин |
| 16 | Мониторинг почты | Gmail + Mail.ru через IMAP | 2 | $0 |
| 17 | Трекинг покупок | Парсинг email-чеков | 2 | $0 |
| 18 | Календарь | Google Calendar синхронизация | 2 | $0 |
| 19 | Еженедельный анализ | Паттерны, тренды, рекомендации | 2 | $0 |
| 20 | Мониторинг файлов | Яндекс.Диск через облачный API | 3 | $0 |
| 21 | Архивация памяти | HOT→WARM→COLD автоматическая | 3 | $0 |
| 22 | Мониторинг БД | Размер, рекомендации по очистке | 3 | $0 |
| 23 | Семантический поиск | pgvector + embeddings | 4 | $0-3/мес |
| 24 | Паттерн-анализатор | Workflow Miner, закономерности | 4 | $0 |
| 25 | Контактный граф | Связи людей и компаний | 4 | $0 |
| 26 | Система целей | Goal tracking (3y→year→month→week) | 4 | $0 |
| 27 | Screenpipe | Мониторинг экрана ПК | 5 | $0 |
| 28 | История браузера | Индексация посещённых страниц | 5 | $0 |
| 29 | Аналитика расходов | Полная картина трат по категориям | 5 | $0 |
| 30 | Банковские push | Авто-проверка оплат через Tasker | 5 | $0 |
| 31 | Авто-ответы | Шаблонные ответы без подтверждения | 6 | $0 |
| 32 | Проактивные подсказки | Shadow Mode lite | 6 | $0 |
| 33 | MCP-интеграции | Todoist, Google Docs, Notion | 6 | $0 |

---

## ЧАСТЬ 12: ЧТО НЕ СТОИТ ДЕЛАТЬ (на любом этапе)

| Не делать | Почему |
|-----------|--------|
| Knowledge Graph (Neo4j) | Преждевременная оптимизация. PostgreSQL + entity_links хватит |
| Supabase | $25/мес, избыточно для 1 пользователя |
| LangChain / LangGraph | Добавляют сложность без реальной выгоды |
| Self-Healing Code | Может зациклиться, ненадёжно |
| Computer Use 24/7 | Технология не созрела (2026) |
| Локальные LLM (Ollama) | Нужен мощный VPS (+$20/мес), качество хуже Claude |
| WhatsApp / Viber | Заблокированы в РФ |
| Фабрика агентов (AutoGen/CrewAI) | Нестабильно |

---

## ЧАСТЬ 13: АНАЛИЗ РЫНКА (для справки)

### Готовые решения — почему не подходят

| Проект | Почему не берём |
|--------|----------------|
| kaymen99/personal-ai-assistant | Нет Яндекс.Диска, Mail.ru, покупок. LangGraph-сложность |
| Agent Second Brain | Только ручной ввод, нет пассивного мониторинга |
| OpenClaw | $40/мес, молодой проект |
| Khoj AI | Нет Telegram из коробки |
| LettaBot (MemGPT) | Overkill |
| n8n | Не делает Telethon. Закрывает ~60% задач |

**Вердикт:** ни одно решение не покрывает: Telethon + Яндекс.Диск + Mail.ru + звонки + покупки + русскоязычная специфика. Делаем своё.

### Что взяли из чужих проектов
- **Agent Second Brain**: Claude CLI как subprocess, inline-кнопка "Запрос", структура goals
- **kaymen99**: идея supervisor + sub-agents (упрощённо)
- **Letta**: концепция разделения HOT/WARM/COLD памяти
- **Screenpipe**: готовый инструмент для Фазы 5

---

## ЧАСТЬ 14: ТИПИЧНЫЙ ДЕНЬ С JARVIS (Фазы 1-3)

### 08:00 — Утренний брифинг
```
Доброе утро. Вот что на сегодня:

КАЛЕНДАРЬ:
- 10:00 — Совещание с Петровым (Zoom)
- 14:00 — Встреча с поставщиком (офис)
- 17:00 — Дедлайн: отправить акт сверки

ПОЧТА (за ночь):
- Gmail: 3 новых. 1 важное — ответ от налоговой
- Mail.ru: 5 новых. Рутина

НАПОМИНАНИЯ:
- Прошло 4 дня — Сидоров не прислал квитанцию
- Завтра — ответ на претензию ООО "Строймонтаж"
- Обещал Иванову перезвонить "в начале недели"

ЗАДАЧИ: 7 активных (2 срочных)

СИСТЕМА: 9/9 OK | CLI mode | БД: 142 MB
```

### 09:15 — Пассивный ловец задач
Ты пишешь Петрову: "Скинь акт до пятницы"
→ Jarvis молча создаёт задачу (confidence 92%, >80% → молча)

### 10:30 — Расшифровка голосового
```
Голосовое от Начальник (10:28, 2 мин):
"Нужно срочно отчёт по маршрутам за январь..."

Задачи:
1. Отчёт по маршрутам (СРОЧНО)
2. Пересчитать пробег
3. Планёрка завтра в 9:00

Добавить? [Да, все] [Выбрать] [Нет]

— CLI mode | 9 модулей OK
```

### 14:30 — Новый файл на Я.Диске
```
Новый файл: /Работа/Смета_Логистик_Транс.xlsx
Связано с: запрос от Логистик-Транс + задача от начальника

— CLI mode | 9 модулей OK
```

### 16:00 — Батч confidence
```
За сегодня я засомневался в 3 сообщениях:

1. [ ] Козлов: "можно и оплатить на неделе" — обещание?
2. [ ] Смирнов: "надо бы встретиться" — задача?
3. [ ] Петров: "попробую до четверга" — обещание?

[Все задачи] [Ничего] [Выбрать]

— CLI mode | 9 модулей OK
```

### 16:05 — Пришёл чек Ozon
(молча сохранено: Шуруповёрт Makita, 4890 руб, доставлен)

### 17:45 — Запись звонка
```
Звонок: Козлов, 5:12
- Оплата за декабрь ушла сегодня
- Просит пересмотреть тариф
- Гарантийное письмо до понедельника

Задачи:
1. Проверить оплату
2. Рассмотреть тариф
3. Ждать письмо до Пн

— CLI mode | 9 модулей OK
```

### 20:00 — Вечерний дайджест
```
ИТОГ ДНЯ — 16 февраля

ВЫПОЛНЕНО: 3 | В РАБОТЕ: 4 | НОВЫХ: 6
КОММУНИКАЦИИ: 47 сообщ | 8 писем | 1 звонок | 3 голосовых
ПОКУПКИ: Makita DF333D, 4890 руб (Ozon)

ТРЕБУЕТ ВНИМАНИЯ:
- Петров: акт сверки (дедлайн пятница)
- Претензия Строймонтаж — завтра!

ПАТТЕРН: 3-ю неделю задерживаешь акты.
Понедельник утро на документы?

СИСТЕМА: 9/9 OK | CLI mode | БД: 142 MB

Спокойной ночи. Завтра планёрка в 9:00.
```

---

## ЧАСТЬ 15: ЧЕГО JARVIS НЕ МОЖЕТ (честно)

1. **Не отправляет без подтверждения** — сознательное ограничение (до Фазы 6)
2. **Не читает чужие чаты** — только те, где ты участник
3. **Не работает с рабочим ПК** — только через Яндекс.Диск
4. **Не звонит** — только расшифровывает записи
5. **Не покупает** — только отслеживает через чеки
6. **Точность речи ~95%** — Whisper иногда ошибается
7. **Точность задач ~85-90%** — спрашивает при неуверенности, учится
8. **Не анализирует фото/скриншоты** — до Фазы 5

---

## ЧАСТЬ 16: ТЕХНОЛОГИЧЕСКИЙ СТЕК

| Компонент | Технология | Фаза |
|-----------|-----------|------|
| VPS | Hetzner CX22 / Timeweb | 0 |
| ОС | Ubuntu 22.04 LTS | 0 |
| Язык | Python 3.11 | 0 |
| Telegram чтение | Telethon | 1 |
| Telegram бот | aiogram 3.x | 1 |
| БД | PostgreSQL 16 | 0 |
| AI (основной) | Claude Code CLI (подписка $100) | 1 |
| AI (запасной) | Claude API (anthropic SDK) | 1 |
| Голос | OpenAI Whisper API | 2 |
| Почта | imaplib | 2 |
| Календарь | Google Calendar API | 2 |
| Файлы | Yandex.Disk REST API | 3 |
| Синхр. звонков | Syncthing | 0 |
| Планировщик | APScheduler | 1 |
| Процесс-менеджер | systemd (Restart=always) | 0 |
| Мониторинг внешний | UptimeRobot | 0 |
| Семантический поиск | pgvector + BGE-M3 | 4 |
| Мониторинг экрана | Screenpipe | 5 |
| Android автоматизация | Tasker | 5 |

---

## ВЕРИФИКАЦИЯ

### Фаза 1 — чеклист:
- [ ] Бот отвечает на "Запрос" с поиском по памяти
- [ ] Сообщения Telegram сохраняются автоматически
- [ ] Задачи извлекаются с confidence-based подтверждением
- [ ] /tasks показывает задачи с дедлайнами
- [ ] Утренний брифинг (08:00) и вечерний дайджест (20:00)
- [ ] Батч confidence в 16:00 (с лимитом 10/день)
- [ ] Срочные confidence-вопросы — сразу
- [ ] /health показывает статус всех модулей
- [ ] watchdog уведомляет при падении + автоперезапуск
- [ ] Эскалация с пошаговыми инструкциями
- [ ] /admin: перезапуск, логи, бэкап через Telegram
- [ ] /mode: переключение CLI/API + индикатор в каждом сообщении
- [ ] Новые контакты → уведомление
- [ ] При падении модуля — остальные работают
- [ ] Реалистичная отправка: "печатает...", задержки, разбивка

### Фаза 2 — чеклист:
- [ ] Голосовые из Telegram расшифровываются
- [ ] Записи звонков приходят через Syncthing и расшифровываются
- [ ] Почта проверяется, важные → в бот
- [ ] Чеки покупок парсятся (Ozon, WB, Avito, YM, VseInstr)
- [ ] "Где покупал X?" возвращает результат
- [ ] Календарь синхронизирован
- [ ] Еженедельный анализ паттернов

### Фаза 3 — чеклист:
- [ ] Яндекс.Диск: новые файлы обнаруживаются через облачный API
- [ ] xlsx/docx: текст извлекается и индексируется
- [ ] Архивация HOT→WARM ежемесячно
- [ ] /health показывает размер БД и уровни памяти
- [ ] "Что за файл я вчера создавал?" → результат

### Фаза 4 — чеклист:
- [ ] Семантический поиск находит "похожие" результаты
- [ ] Еженедельный паттерн-анализ выдаёт полезные инсайты
- [ ] Система целей: goals → задачи
- [ ] Контактный граф работает

### Фаза 5 — чеклист (по необходимости):
- [ ] Screenpipe установлен и данные приходят на VPS
- [ ] История браузера индексируется
- [ ] Расширенная аналитика расходов
- [ ] Банковские push → автопроверка оплат
